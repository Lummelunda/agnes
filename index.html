<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Vad säger Agnes?</title>

  <style>
    * { box-sizing: border-box; }

    :root{
      --maxw: 920px;
      --pad: 16px;
      --radius: 14px;
      --border: #d6d6d6;
      --muted: #666;
      --chip: #f2f2f2;
      --sep: #e2e2e2;
    }

    body{
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: #fff;
      color: #111;
    }

    .container{
      max-width: var(--maxw);
      margin: 0 auto;
      padding: 24px var(--pad) 40px;
      width: 100%;
    }

    h1{
      margin: 0 0 8px;
      font-size: 28px;
      line-height: 1.2;
    }

    .ingress{
      font-size: 13px;
      color: var(--muted);
      margin: 0 0 14px;
    }

    /* Search */
    .search-row{
      position: relative;
      width: 100%;
      margin-bottom: 12px;
    }

    .search-input{
      width: 100%;
      padding: 12px 40px 12px 14px;
      font-size: 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      outline: none;
      display: block;
    }

    .search-input:focus{ border-color: #111; }

    .clear-btn{
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      border: 0;
      background: transparent;
      padding: 0;
      margin: 0;
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
      color: #666;
      display: none;
    }

    .clear-btn:hover{ color: #111; }

    /* Category chips */
    .categories{
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 10px 0 18px;
    }

    .chip{
      padding: 7px 12px;
      border-radius: 999px;
      background: var(--chip);
      font-size: 13px;
      cursor: pointer;
      user-select: none;
      border: 0;
      color: inherit;
      line-height: 1.1;
      white-space: nowrap;
    }

    .chip.active{
      background: #111;
      color: #fff;
    }

    /* Status row (used for both random + list) */
    .status-row{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin: 12px 0 14px;
      font-size: 13px;
      color: var(--muted);
    }

    /* X button style (same as search X) */
    .x-btn{
      border: 0;
      background: transparent;
      padding: 0;
      margin: 0;
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
      color: #666;
    }

    .x-btn:hover{ color: #111; }

    /* Random card */
    .random-wrap{
      border: 1px solid #e7e7e7;
      border-radius: var(--radius);
      padding: 14px;
      margin: 0 0 18px;
      background: #fff;
      position: relative; /* for corner X */
    }

    .random-x{
      position: absolute;
      top: 10px;
      right: 12px;
    }

    /* Cards */
    .card{
      border-bottom: 1px solid var(--sep);
      padding: 16px 0;
    }

    .question{
      font-weight: 650;
      margin-bottom: 8px;
      font-size: 18px;
      line-height: 1.35;
    }

    .answer{
      margin: 0;
      font-size: 16px;
      line-height: 1.55;
      overflow-wrap: anywhere;
    }

    .card-meta{
      font-size: 13px;
      color: var(--muted);
      margin-top: 14px;
      margin-bottom: 10px;
    }

    .tags{
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .tag{
      background: var(--chip);
      font-size: 12px;
      padding: 5px 9px;
      border-radius: 999px;
      cursor: pointer;
      user-select: none;
    }

    mark{ padding: 0 2px; }

    .empty{
      color: #666;
      padding: 18px 0;
    }

    /* Load more */
    .load-more-wrap{
      margin-top: 18px;
      display: flex;
      justify-content: center;
    }

    .btn{
      border: 1px solid var(--border);
      background: #fff;
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
    }

    .btn:disabled{
      opacity: 0.5;
      cursor: not-allowed;
    }

    a{ color: inherit; }
  </style>
</head>

<body>
  <div class="container">
    <h1>Vad säger Agnes?</h1>
    <p id="ingress" class="ingress"></p>

    <div class="search-row">
      <input id="searchInput" class="search-input" placeholder="Sök på ord eller fras…" autocomplete="off">
      <button id="clearBtn" class="clear-btn" type="button" aria-label="Rensa sökfält">×</button>
    </div>

    <div id="categories" class="categories"></div>

    <!-- Status row: text only (no close button here) -->
    <div id="statusRow" class="status-row" style="display:none;">
      <div id="statusText"></div>
      <div></div>
    </div>

    <!-- Random card (only for first empty state) -->
    <div id="randomWrap" class="random-wrap" style="display:none;">
      <button id="randomClose" class="x-btn random-x" type="button" aria-label="Stäng slumpad fråga">×</button>
      <div id="randomCard"></div>
    </div>

    <div id="results"></div>

    <div id="loadMoreWrap" class="load-more-wrap" style="display:none;">
      <button id="loadMoreBtn" class="btn" type="button">Visa fler</button>
    </div>
  </div>

  <script src="./data.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

  <script>
  function norm(str){
    const s = (str || "").toLowerCase();
  
    // Försök modern Unicode (stöd i moderna Chromium + nyare Safari)
    try{
      return s
        .replace(/[^\p{L}\p{N}\s]+/gu, " ")
        .replace(/\s+/g, " ")
        .trim();
    } catch {
      // Fallback (funkar i äldre mobil-Safari)
      return s
        // behåll a–z, 0–9 och svenska åäö
        .replace(/[^a-z0-9åäö\s]+/gi, " ")
        .replace(/\s+/g, " ")
        .trim();
    }
  }

    function tokenize(q){
      return norm(q).split(" ").filter(Boolean);
    }

    function escapeHtml(str){
      return (str || "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",
        "\"":"&quot;","'":"&#039;"
      }[m]));
    }

    function escapeRegExp(s){
      return s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }

    function highlight(text, terms){
      let out = escapeHtml(text);
      for (const t of terms){
        if (t.length < 2) continue;
        const re = new RegExp(`(${escapeRegExp(t)})`, "ig");
        out = out.replace(re, "<mark>$1</mark>");
      }
      return out;
    }

    if (typeof agnesData === "undefined") throw new Error("data.js laddades inte eller agnesData saknas");
    if (typeof Fuse === "undefined") throw new Error("Fuse.js laddades inte.");

    const docs = agnesData.map(d => {
      const kw = Array.isArray(d.keywords) ? d.keywords : [];
      return {
        ...d,
        _keywords: kw,
        _keywordsText: kw.join(" "),
        _dateSafe: d.date || ""
      };
    });

    document.getElementById("ingress").textContent =
      `Sök bland ${docs.length} svar. Baserat på podden “Fråga Agnes Wold” (Sveriges Radio).`;

    const fuse = new Fuse(docs, {
      includeScore: true,
      ignoreLocation: true,
      threshold: 0.35,
      minMatchCharLength: 2,
      keys: [
        { name: "question", weight: 0.60 },
        { name: "_keywordsText", weight: 0.28 },
        { name: "answer", weight: 0.12 }
      ]
    });

    const searchInput = document.getElementById("searchInput");
    const clearBtn = document.getElementById("clearBtn");
    const categoriesEl = document.getElementById("categories");

    const statusRow = document.getElementById("statusRow");
    const statusText = document.getElementById("statusText");

    const randomWrap = document.getElementById("randomWrap");
    const randomCard = document.getElementById("randomCard");
    const randomClose = document.getElementById("randomClose");

    const resultsEl = document.getElementById("results");
    const loadMoreWrap = document.getElementById("loadMoreWrap");
    const loadMoreBtn = document.getElementById("loadMoreBtn");

    let activeCategory = "";
    let visibleCount = 20;
    const step = 20;

    // Random only before any interaction; after that, empty state shows full list.
    let hasInteracted = false;
    function setInteracted(){ hasInteracted = true; }

    function syncClearButton(){
      clearBtn.style.display = searchInput.value.trim() ? "block" : "none";
    }

    function showStatus(text){
      statusRow.style.display = "flex";
      statusText.textContent = text || "";
    }

    clearBtn.addEventListener("click", () => {
      setInteracted();
      searchInput.value = "";
      syncClearButton();
      visibleCount = 20;
      searchInput.focus();
      search();
    });

    searchInput.addEventListener("keydown", (e) => {
      if (e.key === "Escape"){
        setInteracted();
        searchInput.value = "";
        syncClearButton();
        visibleCount = 20;
        search();
      }
    });

    // Category chips (single-select)
    const categorySet = new Set(docs.map(d => d.category1).filter(Boolean));
    [...categorySet].sort((a,b)=>a.localeCompare(b,"sv")).forEach(cat => {
      const chip = document.createElement("button");
      chip.type = "button";
      chip.className = "chip";
      chip.textContent = cat;

      chip.addEventListener("click", () => {
        setInteracted();

        const isSame = (activeCategory === cat);
        activeCategory = isSame ? "" : cat;

        document.querySelectorAll("#categories .chip").forEach(c => c.classList.remove("active"));
        if (!isSame) chip.classList.add("active");

        visibleCount = 20;
        search();
      });

      categoriesEl.appendChild(chip);
    });

    randomClose.addEventListener("click", () => {
      setInteracted();
      visibleCount = 20;
      renderList(getBaseList(), []);
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    function renderCardInto(container, d, terms, withHighlight){
      const q = withHighlight ? highlight(d.question, terms) : escapeHtml(d.question);
      const a = withHighlight ? highlight(d.answer, terms) : escapeHtml(d.answer);

      container.innerHTML = `
        <div class="question">${q}</div>
        <p class="answer">${a}</p>
        <div class="card-meta">
          ${escapeHtml(d.date || "")}
          ${d.category1 ? " · " + escapeHtml(d.category1) : ""}
          ${d.url ? ` · <a href="${escapeHtml(d.url)}" target="_blank" rel="noopener">Källa</a>` : ""}
        </div>
        <div class="tags">
          ${(d._keywords || []).map(k =>
            `<span class="tag" data-kw="${escapeHtml(k)}">${escapeHtml(k)}</span>`
          ).join("")}
        </div>
      `;
    }

    function attachKeywordClicks(scopeEl){
      scopeEl.querySelectorAll(".tag").forEach(tag => {
        tag.addEventListener("click", () => {
          setInteracted();

          const kw = tag.getAttribute("data-kw") || "";
          const cur = searchInput.value.trim();
          searchInput.value = cur ? (cur + " " + kw) : kw;

          syncClearButton();
          visibleCount = 20;
          search();
        });
      });
    }

    function getBaseList(){
      return docs
        .filter(d => !activeCategory || d.category1 === activeCategory)
        .slice()
        .sort((a,b)=>b._dateSafe.localeCompare(a._dateSafe));
    }

    function fuzzyAndSearch(terms){
      const maps = terms.map(t => {
        const res = fuse.search(t, { limit: 500 });
        const m = new Map();
        for (const r of res){
          const d = r.item;
          if (activeCategory && d.category1 !== activeCategory) continue;
          m.set(d.id, (r.score ?? 1));
        }
        return m;
      });

      if (!maps.length) return [];

      const first = maps[0];
      const scored = [];

      for (const [id, sc] of first.entries()){
        let total = sc;
        let ok = true;

        for (let i = 1; i < maps.length; i++){
          const v = maps[i].get(id);
          if (v === undefined){ ok = false; break; }
          total += v;
        }

        if (ok) scored.push({ id, score: total });
      }

      scored.sort((a,b)=>a.score - b.score);

      const scoreMap = new Map(scored.map(x => [x.id, x.score]));
      return docs
        .filter(d => scoreMap.has(d.id))
        .sort((a,b) => (scoreMap.get(a.id) - scoreMap.get(b.id)) || (b._dateSafe.localeCompare(a._dateSafe)));
    }

    function showRandom(){
      showStatus("Slumpad fråga");

      resultsEl.innerHTML = "";
      loadMoreWrap.style.display = "none";

      randomWrap.style.display = "block";
      const random = docs[Math.floor(Math.random() * docs.length)];
      renderCardInto(randomCard, random, [], false);
      attachKeywordClicks(randomWrap);
    }

    function renderList(list, terms){
      randomWrap.style.display = "none";
      randomCard.innerHTML = "";

      resultsEl.innerHTML = "";

      const total = list.length;
      if (!total){
        showStatus("Inga träffar.");
        loadMoreWrap.style.display = "none";
        resultsEl.innerHTML = `<div class="empty">Prova andra ord eller välj en annan kategori.</div>`;
        return;
      }

      const catPart = activeCategory ? ` i ${activeCategory}` : "";
      showStatus(`${total} träffar${catPart}`);

      const shown = list.slice(0, Math.min(visibleCount, total));
      shown.forEach(d => {
        const el = document.createElement("div");
        el.className = "card";
        renderCardInto(el, d, terms, true);
        resultsEl.appendChild(el);
      });

      attachKeywordClicks(resultsEl);

      const canLoadMore = visibleCount < total;
      loadMoreWrap.style.display = canLoadMore ? "flex" : "none";
      loadMoreBtn.disabled = !canLoadMore;

      loadMoreBtn.onclick = () => {
        visibleCount += step;
        renderList(list, terms);
      };
    }

    function search(){
      const terms = tokenize(searchInput.value);
      const nothingSelected = !terms.length && !activeCategory;

      // Random only before any interaction
      if (nothingSelected && !hasInteracted){
        showRandom();
        return;
      }

      // After interaction: empty + no category => full list
      if (nothingSelected && hasInteracted){
        visibleCount = 20;
        renderList(getBaseList(), []);
        return;
      }

      // Search mode
      setInteracted();

      const results = terms.length ? fuzzyAndSearch(terms) : getBaseList();
      renderList(results, terms);
    }

    function debounce(fn, ms=140){
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), ms);
      };
    }

    const debouncedSearch = debounce(() => {
      visibleCount = 20;
      search();
    }, 140);

    searchInput.addEventListener("input", () => {
      syncClearButton();
      if (searchInput.value.trim()) setInteracted();
      visibleCount = 20;
      debouncedSearch();
    });

    // initial
    syncClearButton();
    search();
  </script>
</body>
</html>
