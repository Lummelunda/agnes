<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Vad säger Agnes?</title>

  <style>
    * { box-sizing: border-box; }

    :root{
      --maxw: 920px;
      --pad: 16px;
      --radius: 14px;
      --border: #d6d6d6;
      --muted: #666;
      --chip: #f2f2f2;
      --sep: #e2e2e2;
      --sticky-bg: rgba(255,255,255,0.92);
    }

    body{
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: #fdfdfd;
      color: #111;
    }

    .container{
      max-width: var(--maxw);
      margin: 0 auto;
      padding: 24px var(--pad) 40px;
      width: 100%;
    }

    h1{
      margin: 0 0 8px;
      font-size: 28px;
      line-height: 1.2;
    }

    .ingress{
      font-size: 13px;
      color: var(--muted);
      margin: 0 0 14px;
    }

    /* Sticky header area (search + filters + hits) */
    .sticky-bar{
      position: sticky;
      top: 0;
      z-index: 50;
      background: var(--sticky-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 10px 0 10px;
      border-bottom: 1px solid transparent;
    }

    .sticky-bar.scrolled{
      border-bottom-color: #eee;
    }

    /* Search */
    .search-row{
      position: relative;
      width: 100%;
      margin-bottom: 12px;
    }

    .search-input{
      width: 100%;
      padding: 12px 40px 12px 14px;
      font-size: 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      outline: none;
      display: block;
      background: #fff;
    }

    .search-input:focus{ border-color: #111; }

    .clear-btn{
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      border: 0;
      background: transparent;
      padding: 0;
      margin: 0;
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
      color: #666;
      display: none;
    }

    .clear-btn:hover{ color: #111; }

    /* Mobile filter toggle */
    .filter-toggle-row{
      display: none;
      margin: 2px 0 12px;
    }

    .filter-toggle{
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: #fff;
      font-size: 14px;
      cursor: pointer;
      color: #111;
    }

    .filter-toggle span{
      color: var(--muted);
      font-size: 13px;
    }

    /* Category chips */
    .categories{
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 10px 0 12px;
    }

    .chip{
      padding: 7px 12px;
      border-radius: 999px;
      background: var(--chip);
      font-size: 13px;
      cursor: pointer;
      user-select: none;
      border: 0;
      color: inherit;
      line-height: 1.1;
      white-space: nowrap;
    }

    .chip.active{
      background: #111;
      color: #fff;
    }

    /* Hits line INSIDE sticky */
    .hits{
      font-size: 13px;
      color: var(--muted);
      padding-top: 8px;
      padding-bottom: 2px;
    }

    /* X button style */
    .x-btn{
      border: 0;
      background: transparent;
      padding: 0;
      margin: 0;
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
      color: #666;
    }

    .x-btn:hover{ color: #111; }

    /* Random / Shared card wrappers */
    .panel{
      border: 1px solid #e7e7e7;
      border-radius: var(--radius);
      padding: 14px;
      margin: 0 0 18px;
      background: #fff;
      position: relative;
    }

    .panel-x{
      position: absolute;
      top: 10px;
      right: 12px;
    }

    /* Cards */
    .card{
      border-bottom: 1px solid var(--sep);
      padding: 16px 0;
    }

    .question{
      font-weight: 650;
      margin-bottom: 8px;
      font-size: 18px;
      line-height: 1.35;
    }

    .answer{
      margin: 0;
      font-size: 16px;
      line-height: 1.55;
      overflow-wrap: anywhere;
    }

    .card-meta{
      font-size: 13px;
      color: var(--muted);
      margin-top: 12px;
      margin-bottom: 12px;
    }

    .share{
      text-decoration: underline;
      cursor: pointer;
    }

    .tags{
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .tag{
      background: var(--chip);
      font-size: 12px;
      padding: 5px 9px;
      border-radius: 999px;
      cursor: pointer;
      user-select: none;
    }

    mark{ padding: 0 2px; }

    .empty{
      color: #666;
      padding: 18px 0;
    }

    /* Load more */
    .load-more-wrap{
      margin-top: 18px;
      display: flex;
      justify-content: center;
    }

    .btn{
      border: 1px solid var(--border);
      background: #fff;
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
    }

    .btn:disabled{
      opacity: 0.5;
      cursor: not-allowed;
    }

    a{ color: inherit; }

    @media (max-width: 640px){
      .filter-toggle-row{ display: block; }
      .sticky-bar{ padding-top: 8px; }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Vad säger Agnes?</h1>
    <p id="ingress" class="ingress"></p>

    <div id="stickyBar" class="sticky-bar">
      <div class="search-row">
        <input id="searchInput" class="search-input" placeholder="Sök på ord eller fras…" autocomplete="off">
        <button id="clearBtn" class="clear-btn" type="button" aria-label="Rensa sökfält">×</button>
      </div>

      <div class="filter-toggle-row">
        <button id="toggleCategories" class="filter-toggle" type="button" aria-expanded="false" aria-controls="categories">
          <div id="toggleLabel">Filtrera efter kategori</div>
          <span id="toggleHint">Visa</span>
        </button>
      </div>

      <div id="categories" class="categories"></div>
      <div id="hitsLine" class="hits"></div>
    </div>

    <!-- Anchor: start of results area -->
    <div id="resultsTop" style="height:1px;"></div>

    <!-- Shared link view (single card) -->
    <div id="sharedWrap" class="panel" style="display:none;">
      <button id="sharedClose" class="x-btn panel-x" type="button" aria-label="Stäng delad fråga">×</button>
      <div id="sharedCard"></div>
    </div>

    <!-- Random view (single card) -->
    <div id="randomWrap" class="panel" style="display:none;">
      <button id="randomClose" class="x-btn panel-x" type="button" aria-label="Stäng slumpad fråga">×</button>
      <div id="randomCard"></div>
    </div>

    <div id="results"></div>

    <div id="loadMoreWrap" class="load-more-wrap" style="display:none;">
      <button id="loadMoreBtn" class="btn" type="button">Visa fler</button>
    </div>
  </div>

  <script src="./data.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

  <script>
    function norm(str){
      return (str || "")
        .toLowerCase()
        .replace(/[^\p{L}\p{N}\s]+/gu, " ")
        .replace(/\s+/g, " ")
        .trim();
    }

    function tokenize(q){
      return norm(q).split(" ").filter(Boolean);
    }

    function escapeHtml(str){
      return (str || "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",
        "\"":"&quot;","'":"&#039;"
      }[m]));
    }

    function escapeRegExp(s){
      return s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }

    function highlight(text, terms){
      let out = escapeHtml(text);
      for (const t of terms){
        if (t.length < 2) continue;
        const re = new RegExp(`(${escapeRegExp(t)})`, "ig");
        out = out.replace(re, "<mark>$1</mark>");
      }
      return out;
    }

    if (typeof agnesData === "undefined") throw new Error("data.js laddades inte eller agnesData saknas");
    if (typeof Fuse === "undefined") throw new Error("Fuse.js laddades inte.");

    const docs = agnesData.map(d => {
      const kw = Array.isArray(d.keywords) ? d.keywords : [];
      return {
        ...d,
        _keywords: kw,
        _keywordsText: kw.join(" "),
        _dateSafe: d.date || ""
      };
    });

    const byId = new Map(docs.map(d => [String(d.id), d]));

    document.getElementById("ingress").textContent =
      `Sök bland ${docs.length} svar. Baserat på podden “Fråga Agnes Wold” (Sveriges Radio).`;

    const fuse = new Fuse(docs, {
      includeScore: true,
      ignoreLocation: true,
      threshold: 0.35,
      minMatchCharLength: 2,
      keys: [
        { name: "question", weight: 0.60 },
        { name: "_keywordsText", weight: 0.28 },
        { name: "answer", weight: 0.12 }
      ]
    });

    const stickyBar = document.getElementById("stickyBar");
    const resultsTop = document.getElementById("resultsTop");
    const hitsLine = document.getElementById("hitsLine");

    const searchInput = document.getElementById("searchInput");
    const clearBtn = document.getElementById("clearBtn");
    const categoriesEl = document.getElementById("categories");

    const sharedWrap = document.getElementById("sharedWrap");
    const sharedCard = document.getElementById("sharedCard");
    const sharedClose = document.getElementById("sharedClose");

    const randomWrap = document.getElementById("randomWrap");
    const randomCard = document.getElementById("randomCard");
    const randomClose = document.getElementById("randomClose");

    const resultsEl = document.getElementById("results");
    const loadMoreWrap = document.getElementById("loadMoreWrap");
    const loadMoreBtn = document.getElementById("loadMoreBtn");

    // Mobile categories toggle
    const toggleBtn = document.getElementById("toggleCategories");
    const toggleLabel = document.getElementById("toggleLabel");
    const toggleHint = document.getElementById("toggleHint");

    const isMobileMQ = window.matchMedia && window.matchMedia("(max-width: 640px)");
    function isMobile(){ return !!(isMobileMQ && isMobileMQ.matches); }
    let categoriesOpen = !isMobile();

    function setCategoriesOpen(open){
      categoriesOpen = open;

      if (!isMobile()) {
        categoriesEl.style.display = "flex";
        return;
      }

      categoriesEl.style.display = open ? "flex" : "none";
      toggleBtn.setAttribute("aria-expanded", open ? "true" : "false");
      toggleHint.textContent = open ? "Dölj" : "Visa";
    }

    function updateToggleLabel(){
      if (!isMobile()) return;
      toggleLabel.textContent = activeCategory ? `Kategori: ${activeCategory}` : "Filtrera efter kategori";
    }

    if (toggleBtn){
      toggleBtn.addEventListener("click", () => setCategoriesOpen(!categoriesOpen));
    }

    // App state
    let activeCategory = "";
    let visibleCount = 20;
    const step = 20;

    let hasInteracted = false;
    function setInteracted(){ hasInteracted = true; }

    function syncClearButton(){
      clearBtn.style.display = searchInput.value.trim() ? "block" : "none";
    }

    function setHitsText(text){
      hitsLine.textContent = text || "";
    }

    // Scroll to just below sticky (start of results/panels)
    function scrollToResultsTop(){
      const stickyH = stickyBar.getBoundingClientRect().height;
      const y = resultsTop.getBoundingClientRect().top + window.scrollY - stickyH - 8;
      window.scrollTo({ top: Math.max(0, y), behavior: "smooth" });
    }

    // Hide single-card modes
    function hidePanels(){
      sharedWrap.style.display = "none";
      sharedCard.innerHTML = "";
      randomWrap.style.display = "none";
      randomCard.innerHTML = "";
    }

    function clearHash(){
      if (location.hash) history.replaceState(null, "", location.pathname + location.search);
    }

    // Subtle divider when scrolling
    window.addEventListener("scroll", () => {
      if (window.scrollY > 6) stickyBar.classList.add("scrolled");
      else stickyBar.classList.remove("scrolled");
    }, { passive: true });

    clearBtn.addEventListener("click", () => {
      setInteracted();
      clearHash();          // leaving shared mode if any
      hidePanels();

      searchInput.value = "";
      syncClearButton();
      visibleCount = 20;
      searchInput.focus();
      search(true);
    });

    searchInput.addEventListener("keydown", (e) => {
      if (e.key === "Escape"){
        setInteracted();
        clearHash();
        hidePanels();

        searchInput.value = "";
        syncClearButton();
        visibleCount = 20;
        search(true);
      }
    });

    // Category chips (single-select)
    const categorySet = new Set(docs.map(d => d.category1).filter(Boolean));
    [...categorySet].sort((a,b)=>a.localeCompare(b,"sv")).forEach(cat => {
      const chip = document.createElement("button");
      chip.type = "button";
      chip.className = "chip";
      chip.textContent = cat;

      chip.addEventListener("click", () => {
        setInteracted();
        clearHash();   // leaving shared mode if any
        hidePanels();

        const isSame = (activeCategory === cat);
        activeCategory = isSame ? "" : cat;

        document.querySelectorAll("#categories .chip").forEach(c => c.classList.remove("active"));
        if (!isSame) chip.classList.add("active");

        updateToggleLabel();
        if (isMobile()) setCategoriesOpen(false);

        visibleCount = 20;
        search(true);
      });

      categoriesEl.appendChild(chip);
    });

    sharedClose.addEventListener("click", () => {
      setInteracted();
      clearHash();
      hidePanels();
      visibleCount = 20;
      renderList(getBaseList(), []);
      scrollToResultsTop();
    });

    randomClose.addEventListener("click", () => {
      setInteracted();
      hidePanels();
      visibleCount = 20;
      renderList(getBaseList(), []);
      scrollToResultsTop();
    });

    function renderCardInto(container, d, terms, withHighlight){
      const q = withHighlight ? highlight(d.question, terms) : escapeHtml(d.question);
      const a = withHighlight ? highlight(d.answer, terms) : escapeHtml(d.answer);

      const shareHtml = ` · <a href="#id-${escapeHtml(String(d.id))}" class="share" data-share="${escapeHtml(String(d.id))}">Dela</a>`;

      container.innerHTML = `
        <div class="question">${q}</div>
        <p class="answer">${a}</p>
        <div class="card-meta">
          ${escapeHtml(d.date || "")}
          ${d.category1 ? " · " + escapeHtml(d.category1) : ""}
          ${d.url ? ` · <a href="${escapeHtml(d.url)}" target="_blank" rel="noopener">Källa</a>` : ""}
          ${shareHtml}
        </div>
        <div class="tags">
          ${(d._keywords || []).map(k =>
            `<span class="tag" data-kw="${escapeHtml(k)}">${escapeHtml(k)}</span>`
          ).join("")}
        </div>
      `;
    }

    function attachKeywordClicks(scopeEl){
      scopeEl.querySelectorAll(".tag").forEach(tag => {
        tag.addEventListener("click", () => {
          setInteracted();
          clearHash();     // leaving shared mode if any
          hidePanels();

          const kw = tag.getAttribute("data-kw") || "";
          const cur = searchInput.value.trim();
          searchInput.value = cur ? (cur + " " + kw) : kw;

          syncClearButton();
          visibleCount = 20;
          search(true);
        });
      });
    }

    function attachShareClicks(scopeEl){
      scopeEl.querySelectorAll("[data-share]").forEach(a => {
        a.addEventListener("click", async (e) => {
          e.preventDefault();

          const id = a.getAttribute("data-share");
          const hash = `id-${id}`;
          const url = `${location.origin}${location.pathname}#${hash}`;

          // Set hash (will open shared view)
          location.hash = hash;

          // best effort copy
          try { await navigator.clipboard.writeText(url); } catch {}
        });
      });
    }

    function getBaseList(){
      return docs
        .filter(d => !activeCategory || d.category1 === activeCategory)
        .slice()
        .sort((a,b)=>b._dateSafe.localeCompare(a._dateSafe));
    }

    function fuzzyAndSearch(terms){
      const maps = terms.map(t => {
        const res = fuse.search(t, { limit: 500 });
        const m = new Map();
        for (const r of res){
          const d = r.item;
          if (activeCategory && d.category1 !== activeCategory) continue;
          m.set(String(d.id), (r.score ?? 1));
        }
        return m;
      });

      if (!maps.length) return [];

      const first = maps[0];
      const scored = [];

      for (const [id, sc] of first.entries()){
        let total = sc;
        let ok = true;

        for (let i = 1; i < maps.length; i++){
          const v = maps[i].get(id);
          if (v === undefined){ ok = false; break; }
          total += v;
        }

        if (ok) scored.push({ id, score: total });
      }

      scored.sort((a,b)=>a.score - b.score);

      const scoreMap = new Map(scored.map(x => [x.id, x.score]));
      return docs
        .filter(d => scoreMap.has(String(d.id)))
        .sort((a,b) => (scoreMap.get(String(a.id)) - scoreMap.get(String(b.id))) || (b._dateSafe.localeCompare(a._dateSafe)));
    }

    function showShared(idStr){
      const d = byId.get(idStr);
      hidePanels();
      resultsEl.innerHTML = "";
      loadMoreWrap.style.display = "none";

      if (!d){
        setHitsText("Hittar inte den delade länken.");
        sharedWrap.style.display = "block";
        sharedCard.innerHTML = `<div class="empty">Den här länken verkar inte stämma.</div>`;
        scrollToResultsTop();
        return;
      }

      setHitsText("Delad fråga");
      sharedWrap.style.display = "block";
      renderCardInto(sharedCard, d, [], false);
      attachKeywordClicks(sharedWrap);
      attachShareClicks(sharedWrap);
      scrollToResultsTop();
    }

    function showRandom(){
      hidePanels();
      resultsEl.innerHTML = "";
      loadMoreWrap.style.display = "none";

      setHitsText("Slumpad fråga");
      randomWrap.style.display = "block";
      const random = docs[Math.floor(Math.random() * docs.length)];
      renderCardInto(randomCard, random, [], false);
      attachKeywordClicks(randomWrap);
      attachShareClicks(randomWrap);
    }

    function renderList(list, terms){
      hidePanels();
      resultsEl.innerHTML = "";

      const total = list.length;
      if (!total){
        setHitsText("Inga träffar.");
        loadMoreWrap.style.display = "none";
        resultsEl.innerHTML = `<div class="empty">Prova andra ord eller välj en annan kategori.</div>`;
        return;
      }

      const catPart = activeCategory ? ` i ${activeCategory}` : "";
      setHitsText(`${total} träffar${catPart}`);

      const shown = list.slice(0, Math.min(visibleCount, total));
      shown.forEach(d => {
        const el = document.createElement("div");
        el.className = "card";
        el.id = `id-${d.id}`; // stable anchor for sharing
        renderCardInto(el, d, terms, true);
        resultsEl.appendChild(el);
      });

      attachKeywordClicks(resultsEl);
      attachShareClicks(resultsEl);

      const canLoadMore = visibleCount < total;
      loadMoreWrap.style.display = canLoadMore ? "flex" : "none";
      loadMoreBtn.disabled = !canLoadMore;

      loadMoreBtn.onclick = () => {
        visibleCount += step;
        renderList(list, terms);
      };
    }

    function search(scrollAfter = false){
      const terms = tokenize(searchInput.value);
      const nothingSelected = !terms.length && !activeCategory;

      // If a shared hash exists, shared mode wins
      const hash = (location.hash || "").replace("#", "");
      if (hash.startsWith("id-")){
        hasInteracted = true;
        const idStr = hash.replace("id-", "");
        showShared(idStr);
        return;
      }

      if (nothingSelected && !hasInteracted){
        showRandom();
        if (scrollAfter) scrollToResultsTop();
        return;
      }

      if (nothingSelected && hasInteracted){
        visibleCount = 20;
        renderList(getBaseList(), []);
        if (scrollAfter) scrollToResultsTop();
        return;
      }

      setInteracted();

      const results = terms.length ? fuzzyAndSearch(terms) : getBaseList();
      renderList(results, terms);

      if (scrollAfter) scrollToResultsTop();
    }

    function debounce(fn, ms=140){
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), ms);
      };
    }

    const debouncedSearch = debounce(() => {
      visibleCount = 20;
      search(false);
    }, 140);

    searchInput.addEventListener("input", () => {
      syncClearButton();
      if (searchInput.value.trim()) setInteracted();
      visibleCount = 20;
      debouncedSearch();
    });

    // Handle shared hash changes
    function onHashChange(){
      visibleCount = 20;
      search(true);
    }
    window.addEventListener("hashchange", onHashChange);

    // Initial UI state
    setCategoriesOpen(!isMobile());
    updateToggleLabel();
    syncClearButton();
    search(false);

    if (isMobileMQ){
      isMobileMQ.addEventListener?.("change", () => {
        setCategoriesOpen(!isMobile());
        updateToggleLabel();
      });
    }
  </script>
</body>
</html>
